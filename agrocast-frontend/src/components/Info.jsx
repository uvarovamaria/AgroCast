import { useState } from "react";
import "./Info.css";

export default function Info() {
  const [showSpiDetails, setShowSpiDetails] = useState(false);
  const [showSarimaDetails, setShowSarimaDetails] = useState(false);

  return (
    <div className="info-page">
      <h1>О системе AgroCast</h1>

      <section>
        <h2>Что такое SPI?</h2>
        <p>
          <strong>SPI (Standardized Precipitation Index)</strong> — это индекс,
          который показывает, насколько текущая обеспеченность влагой отличается
          от статистической нормы для выбранного периода. Он не измеряет
          количество осадков напрямую, а показывает, насколько ситуация «хуже / лучше обычного».
        </p>

        <p>Интерпретация SPI:</p>

        <ul>
          <li><strong>SPI &lt; -2.0</strong> — экстремальная засуха</li>
          <li><strong>-2.0 ≤ SPI &lt; -1.5</strong> — сильная засуха</li>
          <li><strong>-1.5 ≤ SPI &lt; -1.0</strong> — умеренная засуха</li>
          <li><strong>-1.0 ≤ SPI ≤ 1.0</strong> — норма</li>
          <li><strong>1.0 &lt; SPI ≤ 1.5</strong> — умеренно влажно</li>
          <li><strong>1.5 &lt; SPI ≤ 2.0</strong> — сильно влажно</li>
          <li><strong>SPI &gt; 2.0</strong> — экстремально влажно</li>
        </ul>

        <p>
          Для аграриев SPI важен тем, что отражает <strong>накопленное действие осадков</strong>
          — например, переход в засушливую фазу или риск заболачивания, а не только «дождь сегодня».
        </p>
      </section>

      <section>
        <h2>Как AgroCast рассчитывает SPI?</h2>

        <p>
          В системе AgroCast SPI считается по историческим данным осадков из сервиса{" "}
          <strong>Meteostat</strong> с учётом выбранного окна (1, 3, 6 месяцев и т.д.).
          Ниже дано общее описание алгоритма, а при разворачивании — более технические детали.
        </p>

        <ol>
          <li>Загружаем суточные осадки за выбранный период (например, 10 лет).</li>
          <li>Складываем их в скользящие суммы за выбранное окно (например, 3 месяца).</li>
          <li>По этим суммам оцениваем статистическое распределение осадков.</li>
          <li>Для каждой даты считаем, насколько текущая сумма «редкая» или «обычная».</li>
          <li>Преобразуем эту редкость в стандартизированный показатель SPI.</li>
        </ol>

        <button
          type="button"
          className="info-toggle"
          onClick={() => setShowSpiDetails((v) => !v)}
        >
          {showSpiDetails
            ? "Свернуть подробный алгоритм"
            : "Показать подробный алгоритм расчёта SPI"}
        </button>

        {showSpiDetails && (
          <div className="info-details">
            <h3>1. Подготовка рядов осадков</h3>
            <p>
              Для выбранной точки (широта/долгота) загружается ряд суточных осадков{" "}
              <code>P(t)</code> за несколько лет (например, 10). Это последовательность
              значений в мм в день:
            </p>
            <p><code>P(t₁), P(t₂), ..., P(tₙ)</code></p>

            <h3>2. Скользящее окно осадков</h3>
            <p>
              Пользователь выбирает окно SPI в месяцах, например <strong>3 месяца</strong>.
              Мы переводим его в дни (≈ 90) и считаем скользящие суммы осадков:
            </p>
            <p>
              <code>S(t) = P(t - N + 1) + ... + P(t)</code>, где N — длина окна в днях.
            </p>
            <p>
              В результате получается ряд <code>S(t)</code>, который показывает,
              сколько осадков накопилось за последние N дней для каждой даты.
            </p>

            <h3>3. Отбор данных для статистики</h3>
            <p>Чтобы корректно оценить распределение осадков, необходимо:</p>
            <ul>
              <li>убрать <strong>NaN</strong> и неготовые окна;</li>
              <li>использовать только суммы, где осадки <strong>&gt; 0</strong>;</li>
              <li>убедиться, что данных достаточно и есть вариация значений.</li>
            </ul>

            <h3>4. Аппроксимация распределения (гамма-распределение)</h3>
            <p>
              Ряд скользящих сумм осадков <code>S(t)</code> часто имеет форму
              «много маленьких значений, редко — большие». Для такой формы
              хорошо подходит <strong>гамма-распределение</strong>.
            </p>
            <p>
              Мы подбираем параметры гамма-распределения — грубо говоря, ищем такие
              <code>k</code> и <code>θ</code>, при которых теоретическое распределение
              лучше всего «похоже» на наши реальные данные.
            </p>

            <h3>5. Переход от суммы осадков к вероятности</h3>
            <p>
              Для каждой даты вычисляем вероятность:
            </p>
            <p>
              <code>G = F<sub>gamma</sub>(S(t))</code>,
            </p>
            <p>
              то есть долю исторических случаев, когда сумма осадков была ≤ текущей.
              Например, <code>G = 0.1</code> означает, что такие малые суммы наблюдались
              только в 10% случаев — это довольно сухо.
            </p>
            <p>
              Для устойчивости не даём <code>G</code> быть ровно 0 или 1 — слегка обрезаем
              по краям (например, от 0.000001 до 0.999999).
            </p>

            <h3>6. Преобразование вероятности в SPI</h3>
            <p>
              Далее переводим вероятность в стандартизированное значение SPI с помощью
              обратной функции нормального распределения:
            </p>
            <p>
              <code>SPI(t) = Φ⁻¹(G)</code>
            </p>
            <p>
              Где <code>Φ</code> — функция распределения стандартной нормали, а
              <code>Φ⁻¹</code> — её обратная (квантиль).
            </p>

            <p>
              В итоге:
            </p>
            <ul>
              <li><strong>SPI ≈ 0</strong> — осадков примерно как обычно;</li>
              <li><strong>SPI &lt; 0</strong> — осадков меньше нормы (сухо);</li>
              <li><strong>SPI &gt; 0</strong> — осадков больше нормы (влажно).</li>
            </ul>

            <h3>7. Категории и рекомендации</h3>
            <p>
              Полученное значение SPI попадает в категорию («умеренная засуха», «норма»,
              «сильно влажно» и т.д.), а на основе категории AgroCast формирует
              <strong>практические рекомендации</strong>:
            </p>
            <ul>
              <li>нужно ли усиливать или снижать полив;</li>
              <li>имеет ли смысл переносить посев;</li>
              <li>стоит ли избегать тяжёлой техники из-за сырости;</li>
              <li>повышается ли риск грибковых заболеваний и т.д.</li>
            </ul>

            <p>
              Таким образом, SPI — это стандартизированный показатель климатического
              риска, который напрямую связан с реальными управленческими решениями.
            </p>
          </div>
        )}
      </section>

      <section>
        <h2>Краткосрочный прогноз на основе Open-Meteo</h2>
        <p>
          Для прогноза SPI на ближайшие 1–16 дней AgroCast использует прогноз осадков
          от сервиса <strong>Open-Meteo</strong>.
        </p>

        <p>Процесс:</p>
        <ol>
          <li>Берём прогноз суточных осадков по координатам.</li>
          <li>Добавляем его к историческим данным.</li>
          <li>Для каждой будущей даты пересчитываем скользящую сумму осадков и SPI.</li>
        </ol>

        <p>
          Это показывает, как ожидаемые дожди или их отсутствие повлияют на влажность
          в ближайшие дни.
        </p>
      </section>

      <section>
        <h2>Долгосрочный прогноз SARIMA</h2>
        <p>
          Для горизонта около 30 дней AgroCast использует модель временных рядов{" "}
          <strong>SARIMA</strong>, которая анализирует сезонность и тренды SPI.
        </p>

        <p>
          Модель обучается на историческом ряде SPI и прогнозирует, как индекс
          изменится в перспективе месяца: в сторону засухи или переувлажнения.
        </p>

        <button
          type="button"
          className="info-toggle"
          onClick={() => setShowSarimaDetails((v) => !v)}
        >
          {showSarimaDetails
            ? "Свернуть подробности SARIMA"
            : "Показать подробности работы SARIMA"}
        </button>

        {showSarimaDetails && (
          <div className="info-details">
            <h3>1. Что такое SARIMA в целом</h3>
            <p>
              <strong>SARIMA</strong> — это модель временных рядов, которая умеет
              учитывать сразу:
            </p>
            <ul>
              <li>авторегрессию (влияние прошлых значений на будущее),</li>
              <li>накопление тренда и сглаживание (интегрирование),</li>
              <li>случайные «шумы» (ошибки прогноза),</li>
              <li>и самое главное — <strong>сезонность</strong> (повторяющиеся паттерны).</li>
            </ul>

            <p>
              Для SPI это важно, потому что климат и осадки обычно ведут себя
              по сезонам: есть «типичный» весенний, летний, осенний и зимний профиль.
            </p>

            <h3>2. На каких данных обучается SARIMA</h3>
            <p>
              В AgroCast в SARIMA подаётся не исходный ряд осадков, а уже рассчитанный
              ряд SPI (например, со скользящим окном в 3 месяца).
            </p>

            <p>То есть модель видит цепочку значений:</p>
            <p><code>SPI(t₁), SPI(t₂), ..., SPI(tₙ)</code></p>

            <p>
              Этот ряд уже «очищен» от масштаба осадков, приведён к стандартизированному виду
              и хорошо подходит для анализа сезонных паттернов.
            </p>

            <h3>3. Сезонная составляющая</h3>
            <p>
              У SARIMA есть параметр сезонности (например, 12 месяцев, если считать по
              месячному SPI). Это позволяет модели учитывать, что значение SPI в июле
              исторически больше похоже на другие июли, чем на январь.
            </p>

            <p>Условно модель учится вещам типа:</p>
            <ul>
              <li>«После нескольких сухих месяцев обычно идёт компенсирующая влажная фаза»;</li>
              <li>«В этой климатической зоне весной часто наблюдается недобор осадков»;</li>
              <li>«Осенью SPI чаще уходит в плюсовую область».</li>
            </ul>

            <h3>4. Как выглядит прогноз</h3>
            <p>
              После подбора параметров SARIMA генерирует прогноз SPI вперёд — в AgroCast
              нас интересует, например, точка через 30 дней:
            </p>

            <p>
              <code>SPI(t + 30)</code> — ожидаемое значение индекса с учётом
              всей предшествующей истории и сезонности.
            </p>

            <p>
              Модель не знает точного будущего прогноза погоды, зато хорошо умеет
              использовать многолетнюю динамику SPI.
            </p>

            <h3>5. Как это интерпретируется в системе</h3>
            <p>
              Полученное прогнозное значение SPI переводится:
            </p>
            <ul>
              <li>в категорию (например, «умеренная засуха через 30 дней»),</li>
              <li>в набор рекомендаций: стоит ли заранее готовиться к сухому периоду
                  или, наоборот, к затяжной сырости.</li>
            </ul>

            <p>
              Важно понимать, что это <strong>не точный прогноз погоды</strong>, а
              прогноз <strong>климатического режима влагообеспеченности</strong>:
              перейдём ли мы в более сухую или более влажную фазу относительно нормы.
            </p>

            <h3>6. Зачем нужен такой прогноз аграриям</h3>
            <p>Примеры использования:</p>
            <ul>
              <li>
                Если SARIMA показывает переход в зону отрицательных SPI, можно заранее
                планировать увеличение орошения и выбирать менее требовательные к влаге культуры.
              </li>
              <li>
                Если ожидается устойчиво положительный SPI, можно учесть риски
                заболачивания и всплеска болезней.
              </li>
              <li>
                Можно более осознанно выбирать сроки посева и обработки почвы.
              </li>
            </ul>

            <p>
              Таким образом, SARIMA в AgroCast — это инструмент <strong>стратегического
              прогнозирования</strong>, дополняющий краткосрочный прогноз на основе Open-Meteo.
            </p>
          </div>
        )}
      </section>

      <section>
        <h2>Что даёт AgroCast?</h2>

        <ul>
          <li>Оценка текущего состояния влагообеспеченности по SPI</li>
          <li>Исторический анализ за несколько лет</li>
          <li>Краткосрочный прогноз SPI по данным погоды</li>
          <li>Долгосрочный прогноз SPI по SARIMA</li>
          <li>Практические рекомендации по управлению агрорисками</li>
        </ul>

        <p>
          Система соединяет климатические индексы, прогноз погоды и алгоритмы анализа
          данных, чтобы помочь сельхозпроизводителям принимать более взвешенные решения.
        </p>
      </section>
    </div>
  );
}
